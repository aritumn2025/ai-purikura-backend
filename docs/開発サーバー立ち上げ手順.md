# 開発サーバー立ち上げ手順

この手順は **Nest.js + Prisma + PostgreSQL(Docker)** 環境での開発用サーバー立ち上げ方法です。

---

## 1. 環境準備

- 前提条件:
  - Docker / Docker Compose がインストール済み
  - Node.js / npm がインストール済み
  - このプロジェクトをクローン済み

---

## 2. 環境変数の設定

プロジェクトルートに `.env` ファイルを作成し、データベース接続情報を記述してください。

```env
# .env
DATABASE_URL="postgresql://nestuser:nestpass@localhost:5432/nestdb?schema=public"
```

- `nestuser`、`nestpass`、`nestdb` は docker-compose.yml に設定されている値と一致させること
- 機密情報のため、`.env` は Git には含めないでください（`.gitignore` には追加されているので、特に何もする必要はありません）

---

## 3. DB コンテナの起動

1. プロジェクトルートに移動

```bash
cd ./ai-purikura-backend
```

2. Docker Compose で DB を立ち上げる

```bash
docker compose up -d
```

- 初回実行時は PostgreSQL イメージを自動でダウンロードします
- 起動中のコンテナを確認するには

```bash
docker ps
```

- DBコンテナ停止／削除:

```bash
docker compose down
```

---

## 4. Prisma の初期化・マイグレーション

1. 必要なパッケージのインストール

```bash
npm install
```

2. DB スキーマを反映するマイグレーション

```bash
npx prisma migrate dev --name init
```

3. DB をブラウザで確認する場合（オプション）

```bash
npx prisma studio
```

- ブラウザで `http://localhost:5555` にアクセスすると DB の内容を確認可能

---

## 5. Nest.js サーバーの起動

1. 依存パッケージのインストール

```bash
npm install
```

2. 開発サーバーの起動

```bash
npm run start:dev
```

- デフォルトでは `http://localhost:4000` でサーバーが起動
- ポート変更が必要な場合は `main.ts` や `.env` で調整可能

---

## 6. 開発用Tips

- DB 操作は Prisma Client を経由して行ってください
- 新しいテーブルやフィールドを追加した場合は再度 `npx prisma migrate dev` を実行
- サーバーを停止する場合は `Ctrl+C` で終了、DB は Docker Compose のまま残ります

---

## 7. まとめ

| サービス             | URL / ポート                                   | 備考                  |
| -------------------- | ---------------------------------------------- | --------------------- |
| Nest.js 開発サーバー | [http://localhost:4000](http://localhost:4000) | `npm run start:dev`   |
| PostgreSQL DB        | localhost:5432                                 | Docker Compose で起動 |
| Prisma Studio        | [http://localhost:5555](http://localhost:5555) | DB内容確認用 GUI      |

---

💡 **注意**

- DB接続情報は `.env` に集約し、Gitには含めない
- Dockerの権限エラーが出る場合は、ユーザーを `docker` グループに追加するか `sudo` を使用してください

```bash
# docker グループが存在するか確認
grep docker /etc/group

# 存在しない場合は作成
sudo groupadd docker

# 現在のユーザーを docker グループに追加
sudo usermod -aG docker $USER

# 変更を反映するため一度ログアウト/ログイン
newgrp docker

```
